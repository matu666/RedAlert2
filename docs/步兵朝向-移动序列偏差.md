# 步兵（E1）移动时对角朝向显示偏差 - 问题说明与后续修改建议

## 背景

- 在 `/inftest` 中，E1 的八向朝向完全正确：
  - 0 上、1 左上、2 左、3 左下、4 下、5 右下、6 右、7 右上。
- 在交互测试页（`/unitmovementtest`，行进态使用 Walk 序列）中，对角方向出现偏差：
  - 1 左上 → 显示为 左下
  - 3 左下 → 显示为 右下
  - 5 右下 → 显示为 左下
  - 7 右上 → 显示为 右下
  - 上/下/左/右（偶数面）正常。

## 已对齐项（确认不太可能的原因）

- 面号计算与原项目保持一致：
  - Infantry：`computeFacingNumber(direction) = round(((direction - 45 + 360) % 360) / 360 * 8) % 8`
  - `directionFromFacingNo(n) = 45 + 360/8 * n`
- `FacingUtil.fromMapCoords(vec)` 与原项目一致。
- 撤销了在 `FootLocomotor` 中对 `direction` 的临时 +45° 偏移，恢复原行为。

## 现象分析（核心结论）

- 问题并非“算法与原项目不一致”，而更像是“同一兵种在不同序列（Stand/Ready vs Walk）中的帧朝向顺序不一致”。
  - `/inftest` 静态观察用的序列（Ready/Stand）帧块与期望完全匹配。
  - `/unitmovementtest` 行进中使用 Walk 序列。E1 的 Walk 序列在素材里很可能采用“优先下方对角”的顺序（如 S→SW→W→NW→N→NE→E→SE），与静态序列的“上、左、下、右”顺序不一致，导致奇数面（对角）被落在“偏下”的帧块上。

> 注：这类差异在西木引擎时代的 SHP 资源中是常见情况，站立/行走/开火序列的帧面的组织方式并不总是完全一致。

## 另一个重要怀疑点（需要验证）

- 两处测试的 Theater 不同：
  - `/inftest` 当前使用 `TheaterType.Snow`
  - `/unitmovementtest` 使用 `TheaterType.Temperate`
- 若 E1 的美术条目启用了剧院变体（如 `AlternateArcticArt/Theater`），不同剧院可能加载到不同的 SHP 变体，行走序列的“帧面顺序”也随之不同。
  - 验证方式：打印 `renderable.objectArt.imageName` 与 `useTheaterExtension/alternateArcticArt` 相关配置，确认是否不同测试页加载了不同 SHP。

## 复现与当前对照

- `/inftest`：使用新增的 Facing 下拉（0-7）与 Direction 输入（0-359）可以稳定观察八向，E1 正常。
- `/unitmovementtest`：右键发出 Move，行进中奇数面对角显示偏差，如上表。

## 建议的验证步骤（不改动资源与算法，先查证）

1. 统一剧院后再对比：
   - 临时让 `/inftest` 与 `/unitmovementtest` 使用同一 Theater（例如都用 Temperate），再次对照八向。
   - 记录 `renderable.objectArt.imageName` 确认是否加载到相同的 SHP。
2. 打印序列参数以确认 Walk 帧布局：
   - `const seq = renderable.objectArt.sequences.get(SequenceType.Walk)`
   - 核对 `startFrame / frameCount / facingMult` 是否满足 `frameCount === facingMult * 8`；若一致仍错，说明“每个面所在帧块”的顺序与我们计算的面号顺序不一致。
3. 打印渲染时的面号与帧索引：
   - 在 `Infantry.updateShapeFrame()` 中临时 `console.log({ direction: this.computedDirection, facingNumber, startFrame, facingMult, frameIndex })`，确认错误发生在“面号→帧块”的映射阶段，而非方向角计算。

## 可选修复方案（按由小到大、可回滚原则）

1. 最小侵入修复（仅 Walk 生效，测试页可开关）：
   - 在 `Infantry.updateShapeFrame()` 对 Walk 序列下的奇数面号做 remap，使其与 `/inftest` 的朝向表一致（偶数不变，奇数面根据素材偏移 ±2）。
   - 优点：不影响 Stand/Fire 等序列；风险低；方便 A/B 检验；可加测试页开关。
2. 数据层（更稳妥，但成本高）：
   - 若确认是某个剧院或变体的 SHP 帧顺序问题，可在 `Art/INI` 中为该变体单独提供 Walk 的 facing 顺序描述（若引擎支持），或替换为与 Stand 一致的资源。
3. 引擎层通用化（中期）：
   - 扩展序列模型：为每个序列（至少 Walk）允许定义一个 `facingOrder`（长度为 8 的面序数组），渲染时用它将 `facingNumber` 映射到正确的帧块索引。
   - 优点：能覆盖更多单位与变体；缺点：需要扩展解析与渲染，测试面更广。

## 风险与回归面

- 任何 remap 都需确保仅影响步兵 Walk（或明确受影响的序列），不能波及 Stand/Fire/Death 等序列。
- 与剧院相关的变体要分别测试（Temperate/Snow/Urban 等），避免一处修复在另一处倒挂。

## 接受标准（Acceptance Criteria）

- 在 `/inftest` 与 `/unitmovementtest` 中，对 E1 的八向朝向对齐如下（移动与静态一致）：
  - 0 上、1 左上、2 左、3 左下、4 下、5 右下、6 右、7 右上。
- 在至少两种 Theater 下（Temperate/Snow）验证一致。
- 站立、行走、开火三类常见序列的朝向切换平滑，无倒向或面号跳变。

## 后续计划（建议顺序）

1. 先做“剧院统一 + 序列/帧索引日志”验证，坐实差异根因（Walk 帧序 vs Stand 帧序；或剧院变体差异）。
2. 在测试页加一个开关，启用“Walk 序列奇数面 remap”，对 E1 做 A/B。
3. 若 A/B 成功，再评估是否把 remap 推广到存在同样问题的其它步兵；或升级为 `facingOrder` 通用解。
4. 最后，根据团队偏好决定是保留引擎层 remap 还是改资源/INI。

---

备注：本说明仅罗列现象、假设与验证/修复方案，暂不改动任何现有逻辑，待确认后再实施。


